<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player Overlay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: transparent;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .music-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(50, 50, 50, 0.95));
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .music-container.show {
            transform: translateY(0);
        }

        .current-song {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .album-art {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .album-art.spinning {
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .song-info {
            flex: 1;
            min-width: 0;
        }

        .song-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-artist {
            font-size: 14px;
            color: #b3b3b3;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-requester {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .platform-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
        }

        .platform-spotify {
            background: #1db954;
        }

        .platform-youtube {
            background: #ff0000;
        }

        .progress-container {
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #888;
        }

        .queue-section {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .queue-header {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .queue-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .queue-list {
            max-height: 120px;
            overflow-y: auto;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .queue-item:last-child {
            border-bottom: none;
        }

        .queue-position {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #888;
            flex-shrink: 0;
        }

        .queue-song-info {
            flex: 1;
            min-width: 0;
        }

        .queue-song-title {
            font-size: 13px;
            color: #ffffff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .queue-song-artist {
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .queue-duration {
            font-size: 11px;
            color: #666;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            color: #888;
            font-size: 13px;
            padding: 20px;
        }

        .music-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùºÎßÅ */
        .queue-list::-webkit-scrollbar {
            width: 4px;
        }

        .queue-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .queue-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .queue-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* ÏÉà Í≥° ÏïåÎ¶º Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .new-song-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .new-song-alert.show {
            transform: translateX(0);
        }

        .alert-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alert-content {
            font-size: 12px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div id="musicContainer" class="music-container">
        <!-- ÌòÑÏû¨ Ïû¨ÏÉù Ï§ëÏù∏ Í≥° -->
        <div id="currentSong" class="current-song" style="display: none;">
            <div class="album-art spinning">
                <img id="albumArt" src="" alt="Album Art" style="display: none;">
                <span id="albumIcon">üéµ</span>
            </div>
            <div class="song-info">
                <div id="songTitle" class="song-title">Í≥° Ï†úÎ™©</div>
                <div id="songArtist" class="song-artist">ÏïÑÌã∞Ïä§Ìä∏</div>
                <div id="songRequester" class="song-requester">ÏöîÏ≤≠Ïûê: ÏÇ¨Ïö©Ïûê</div>
            </div>
            <div id="platformBadge" class="platform-badge platform-spotify">S</div>
        </div>

        <!-- ÏßÑÌñâÎ•† Î∞î -->
        <div id="progressContainer" class="progress-container" style="display: none;">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div class="progress-time">
                <span id="currentTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>
        </div>

        <!-- ÌÅê ÏÑπÏÖò -->
        <div class="queue-section">
            <div class="queue-header">
                <span>üé∂ ÎåÄÍ∏∞Ïó¥</span>
                <span id="queueCount" class="queue-count">0</span>
            </div>
            <div id="queueList" class="queue-list">
                <!-- ÌÅê ÏïÑÏù¥ÌÖúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
            <div id="emptyState" class="empty-state">
                <div class="music-icon">üéµ</div>
                <div>ÏùåÏïÖÏùÑ ÏöîÏ≤≠Ìï¥Î≥¥ÏÑ∏Ïöî!</div>
                <div style="margin-top: 4px; font-size: 11px;">!music Í≥°Î™Ö or URL</div>
            </div>
        </div>
    </div>

    <!-- ÏÉà Í≥° ÏïåÎ¶º -->
    <div id="newSongAlert" class="new-song-alert">
        <div class="alert-title">üéµ ÏÉà Í≥°Ïù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!</div>
        <div id="alertContent" class="alert-content"></div>
    </div>

    <script>
        class MusicOverlay {
            constructor() {
                this.ws = null;
                this.currentSong = null;
                this.queue = [];
                this.currentTime = 0;
                this.totalTime = 0;
                this.isPlaying = false;
                
                this.initWebSocket();
                this.initElements();
                this.startProgressTimer();
            }

            initElements() {
                this.container = document.getElementById('musicContainer');
                this.currentSongEl = document.getElementById('currentSong');
                this.progressContainer = document.getElementById('progressContainer');
                this.songTitle = document.getElementById('songTitle');
                this.songArtist = document.getElementById('songArtist');
                this.songRequester = document.getElementById('songRequester');
                this.albumArt = document.getElementById('albumArt');
                this.albumIcon = document.getElementById('albumIcon');
                this.platformBadge = document.getElementById('platformBadge');
                this.progressFill = document.getElementById('progressFill');
                this.currentTimeEl = document.getElementById('currentTime');
                this.totalTimeEl = document.getElementById('totalTime');
                this.queueList = document.getElementById('queueList');
                this.queueCount = document.getElementById('queueCount');
                this.emptyState = document.getElementById('emptyState');
                this.newSongAlert = document.getElementById('newSongAlert');
                this.alertContent = document.getElementById('alertContent');
            }

            initWebSocket() {
                const wsUrl = 'ws://localhost:8080';
                
                try {
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        console.log('üéµ Music Overlay WebSocket Ïó∞Í≤∞Îê®');
                        this.loadInitialData();
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleWebSocketMessage(data);
                        } catch (error) {
                            console.error('WebSocket Î©îÏãúÏßÄ ÌååÏã± Ïò§Î•ò:', error);
                        }
                    };
                    
                    this.ws.onclose = () => {
                        console.log('üéµ Music Overlay WebSocket Ïó∞Í≤∞ ÎÅäÍπÄ, Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ...');
                        setTimeout(() => this.initWebSocket(), 3000);
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket Ïò§Î•ò:', error);
                    };
                } catch (error) {
                    console.error('WebSocket Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                    setTimeout(() => this.initWebSocket(), 5000);
                }
            }

            async loadInitialData() {
                try {
                    const response = await fetch('/music/queue');
                    const data = await response.json();
                    
                    if (data.current) {
                        this.updateCurrentSong(data.current);
                    }
                    
                    if (data.queue) {
                        this.updateQueue(data.queue);
                    }
                } catch (error) {
                    console.error('Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                }
            }

            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'music_request_added':
                        this.handleMusicRequestAdded(data.data);
                        break;
                    case 'music_song_started':
                        this.handleSongStarted(data.data);
                        break;
                    case 'music_song_ended':
                        this.handleSongEnded(data.data);
                        break;
                    case 'music_queue_updated':
                        this.updateQueue(data.data);
                        break;
                    case 'music_progress':
                        this.updateProgress(data.data);
                        break;
                }
            }

            handleMusicRequestAdded(data) {
                this.showNewSongAlert(data);
                this.loadInitialData(); // ÌÅê ÏÉàÎ°úÍ≥†Ïπ®
            }

            handleSongStarted(data) {
                this.updateCurrentSong(data);
                this.isPlaying = true;
                this.currentTime = 0;
            }

            handleSongEnded() {
                this.currentSong = null;
                this.isPlaying = false;
                this.updateDisplay();
            }

            updateCurrentSong(song) {
                this.currentSong = song;
                this.totalTime = song.duration || 0;
                this.currentTime = 0;
                this.isPlaying = true;
                
                this.updateDisplay();
            }

            updateQueue(queue) {
                this.queue = queue || [];
                this.updateDisplay();
            }

            updateProgress(data) {
                this.currentTime = data.current_time || 0;
                this.updateProgressBar();
            }

            updateDisplay() {
                const hasCurrentSong = this.currentSong !== null;
                const hasQueue = this.queue.length > 0;

                // Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú/Ïà®ÍπÄ
                if (hasCurrentSong || hasQueue) {
                    this.container.classList.add('show');
                } else {
                    this.container.classList.remove('show');
                    return;
                }

                // ÌòÑÏû¨ Í≥° ÌëúÏãú
                if (hasCurrentSong) {
                    this.currentSongEl.style.display = 'flex';
                    this.progressContainer.style.display = 'block';
                    
                    this.songTitle.textContent = this.currentSong.title || 'Ïïå Ïàò ÏóÜÎäî Í≥°';
                    this.songArtist.textContent = this.currentSong.artist || 'Ïïå Ïàò ÏóÜÎäî ÏïÑÌã∞Ïä§Ìä∏';
                    this.songRequester.textContent = `ÏöîÏ≤≠Ïûê: ${this.currentSong.requester_nickname || this.currentSong.requester || 'ÏùµÎ™Ö'}`;
                    
                    // ÌîåÎû´Ìèº Î∞∞ÏßÄ
                    const platform = this.currentSong.platform || 'unknown';
                    this.platformBadge.className = `platform-badge platform-${platform}`;
                    this.platformBadge.textContent = platform === 'spotify' ? 'S' : platform === 'youtube' ? 'Y' : '?';
                    
                    // Ïï®Î≤î ÏïÑÌä∏
                    if (this.currentSong.thumbnail) {
                        this.albumArt.src = this.currentSong.thumbnail;
                        this.albumArt.style.display = 'block';
                        this.albumIcon.style.display = 'none';
                    } else {
                        this.albumArt.style.display = 'none';
                        this.albumIcon.style.display = 'block';
                        this.albumIcon.textContent = platform === 'spotify' ? 'üéµ' : platform === 'youtube' ? 'üì∫' : 'üé∂';
                    }
                    
                    this.updateProgressBar();
                } else {
                    this.currentSongEl.style.display = 'none';
                    this.progressContainer.style.display = 'none';
                }

                // ÌÅê ÌëúÏãú
                this.queueCount.textContent = this.queue.length;
                this.emptyState.style.display = hasQueue ? 'none' : 'block';
                
                this.queueList.innerHTML = '';
                this.queue.slice(0, 5).forEach((song, index) => {
                    const item = this.createQueueItem(song, index + 1);
                    this.queueList.appendChild(item);
                });
            }

            createQueueItem(song, position) {
                const item = document.createElement('div');
                item.className = 'queue-item';
                
                const duration = this.formatTime(song.duration || 0);
                
                item.innerHTML = `
                    <div class="queue-position">${position}</div>
                    <div class="queue-song-info">
                        <div class="queue-song-title">${song.title || 'Ïïå Ïàò ÏóÜÎäî Í≥°'}</div>
                        <div class="queue-song-artist">${song.artist || 'Ïïå Ïàò ÏóÜÎäî ÏïÑÌã∞Ïä§Ìä∏'}</div>
                    </div>
                    <div class="queue-duration">${duration}</div>
                `;
                
                return item;
            }

            updateProgressBar() {
                if (!this.currentSong || this.totalTime === 0) {
                    this.progressFill.style.width = '0%';
                    this.currentTimeEl.textContent = '0:00';
                    this.totalTimeEl.textContent = '0:00';
                    return;
                }

                const progress = (this.currentTime / this.totalTime) * 100;
                this.progressFill.style.width = `${Math.min(progress, 100)}%`;
                
                this.currentTimeEl.textContent = this.formatTime(this.currentTime);
                this.totalTimeEl.textContent = this.formatTime(this.totalTime);
            }

            startProgressTimer() {
                setInterval(() => {
                    if (this.isPlaying && this.currentSong && this.currentTime < this.totalTime) {
                        this.currentTime += 1;
                        this.updateProgressBar();
                    }
                }, 1000);
            }

            showNewSongAlert(song) {
                this.alertContent.textContent = `${song.title} - ${song.artist}`;
                this.newSongAlert.classList.add('show');
                
                setTimeout(() => {
                    this.newSongAlert.classList.remove('show');
                }, 4000);
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // Ïò§Î≤ÑÎ†àÏù¥ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            new MusicOverlay();
        });
    </script>
</body>
</html>